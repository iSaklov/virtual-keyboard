import keyboardLayouts from './keyboard-layout.js'

// alert('–ó–¥–µ—Å—å –∫–∏–ø–∏—Ç —Ä–∞–±–æ—Ç–∞ ü§Ø')
// alert('–†–∞–±–æ—Ç–∞ –Ω–∞–¥ –∑–∞–¥–∞–Ω–∏–µ–º –ø—Ä–∏–≤–µ–ª–∞ –∫ –≥–ª—É–±–æ–∫–æ–π –¥–µ–ø—Ä–µ—Å—Å–∏–∏')
// alert('–ë—É–¥—É –æ—á–µ–Ω—å –ø—Ä–∏–∑–Ω–∞—Ç–µ–ª–µ–Ω, –µ—Å–ª–∏ —Å–º–æ–∂–µ—à—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –º–µ–Ω—è –≤ –ø–æ—Å–ª–µ–¥–Ω—é—é –æ—á–µ—Ä–µ–¥—å')

// let currentLanguage = localStorage.getItem('language') || 'en' // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —è–∑—ã–∫ –∏–ª–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∞–Ω–≥–ª–∏–π—Å–∫–∏–π

let currentLanguage = localStorage.getItem('language') || 'en'


const keyboard = document.createElement('div')
keyboard.classList.add('keyboard')

const textarea = document.createElement('textarea')
textarea.classList.add('textarea')

const title = document.createElement('h1')
title.innerText =
	currentLanguage === 'en'
		? 'RSS Virtual Keyboard'
		: 'RSS –í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞'
title.classList.add('title')

const span1 = document.createElement('span')
span1.innerText =
	currentLanguage === 'en'
		? 'The keyboard was created in the operating system Mac OS'
		: '–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å–æ–∑–¥–∞–Ω–∞ –≤ –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ Mac OS'
span1.classList.add('span')

const span2 = document.createElement('span')
span2.innerText =
	currentLanguage === 'en'
		? 'To switch the language, the combination: left ctrl + space'
		: '–î–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —è–∑—ã–∫–∞ –∫–æ–º–±–∏–Ω–∞—Ü–∏—è: –ª–µ–≤—ã–π ctrl + –ø—Ä–æ–±–µ–ª'
span2.classList.add('span')

document.body.append(title, textarea, keyboard, span1, span2)

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤—Å–µ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —è–∑—ã–∫–æ–≤
function initKeyboard(language) {
	const keys = keyboardLayouts[language].map((row) => {
		const rowElement = document.createElement('div')
		rowElement.classList.add('keyboard-row')

		row.forEach((item) => {
			const isLetter = /^[a-zA-Z–∞-—è–ê-–Ø—ë–Å]$/.test(item.key)
			const button = document.createElement('button')
			button.classList.add('keyboard-key')

			if (item.action) {
				button.setAttribute('data-action', item.action)
			}

			if (item.shiftKey) {
				button.setAttribute('data-shiftKey', item.shiftKey)
			}

			if (isLetter) {
				button.setAttribute('data-keyType', 'letter')
			}

			button.setAttribute('data-code', item.code)
			button.setAttribute('data-key', item.key)

			rowElement.append(button)
		})

		return rowElement
	})

	keyboard.append(...keys)
}

// –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
initKeyboard(currentLanguage)

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ –º—ã—à—å—é
keyboard.addEventListener('click', (event) => {
	if (event.target.classList.contains('keyboard-key')) {
		if (!event.target.dataset.action) {
			if (
				capslockButton.classList.contains('active') ||
				keyboard.classList.contains('shift-pressed')
			) {
				insertText(event.target.dataset.shiftkey)
			} else {
				insertText(event.target.dataset.key)
			}
		}

		switch (event.target.dataset.action) {
			case 'Backspace':
				deleteText(-1)
				break
			case 'Delete':
				deleteText(1)
				break
			case 'Tab':
				insertText('    ')
				break
			case 'Enter':
				insertText('\n')
				break
			case 'CapsLock':
				capslockButton.classList.toggle('active')
				toggleCapsLock()
				break
			case 'ArrowUp':
				insertText(event.target.dataset.key)
				break
			case 'ArrowDown':
				insertText(event.target.dataset.key)
				break
			case 'ArrowLeft':
				insertText(event.target.dataset.key)
				break
			case 'ArrowRight':
				insertText(event.target.dataset.key)
				break
		}
	}
})

const capslockButton = document.querySelector('button[data-code="CapsLock"]')
capslockButton.classList.add('capslock')

const shiftButtons = document.querySelectorAll('button[data-action="Shift"]')

shiftButtons.forEach((button) => {
	button.addEventListener('mousedown', () => {
		keyboard.classList.add('shift-pressed')
		toggleShift()
	})
})

shiftButtons.forEach((button) => {
	button.addEventListener('mouseup', () => {
		keyboard.classList.remove('shift-pressed')
		toggleShift()
	})
})

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –∫–ª–∞–≤–∏—à –Ω–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ
document.addEventListener('keydown', (event) => {
	const key = event.key

	// –û—Ç–º–µ–Ω—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
	event.preventDefault()

	// –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –Ω–∞–∂–∞—Ç—É—é –∫–ª–∞–≤–∏—à—É –Ω–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ
	highlightKey(event.code)

	// –í–≤–æ–¥ —Å–∏–º–≤–æ–ª–∞ –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ
	if (key.length === 1 && !event.ctrlKey && !event.altKey && !event.metaKey) {
		insertText(key)
	}

	// –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–º—É –ø–æ–ª—é
	switch (key) {
		case 'Backspace':
			deleteText(-1)
			break
		case 'Delete':
			deleteText(1)
			break
		case 'Tab':
			insertText('    ')
			break
		case 'Enter':
			insertText('\n')
			break
		case 'CapsLock':
			capslockButton.classList.toggle(
				'active',
				event.getModifierState('CapsLock')
			)
			toggleCapsLock()
			break
		case 'Shift':
			keyboard.classList.add('shift-pressed')
			toggleShift()
			break
		case 'ArrowUp':
			insertText('‚Üë')
			break
		case 'ArrowDown':
			insertText('‚Üì')
			break
		case 'ArrowLeft':
			insertText('‚Üê')
			break
		case 'ArrowRight':
			insertText('‚Üí')
			break
	}
})

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–∂–∞—Ç–∏—è –∫–ª–∞–≤–∏—à –Ω–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ
document.addEventListener('keyup', (event) => {
	if (event.key === 'CapsLock') {
		capslockButton.classList.toggle(
			'active',
			event.getModifierState('CapsLock')
		)
		toggleCapsLock()
	}
	if (event.key === 'Shift') {
		keyboard.classList.remove('shift-pressed')
		toggleShift()
	}

	// –°–Ω–∏–º–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å –∫–ª–∞–≤–∏—à–∏ –Ω–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ
	unhighlightKey(event.code)
})

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –∫–ª–∞–≤–∏—à–∏ –Ω–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ
function highlightKey(code) {
	const button = getButtonByCode(code)
	if (button) {
		button.classList.add('active')
	}
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–Ω—è—Ç–∏—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ —Å –∫–ª–∞–≤–∏—à–∏ –Ω–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ
function unhighlightKey(code) {
	const button = getButtonByCode(code)
	if (button) {
		button.classList.remove('active')
	}
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –Ω–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ –ø–æ –∫–æ–¥—É
function getButtonByCode(code) {
	return keyboard.querySelector(`button[data-code="${code}"]`)
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ —Å–∏–º–≤–æ–ª–∞ –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ
function insertText(string) {
	const textarea = document.querySelector('.textarea')
	const cursorPosStart = textarea.selectionStart
	const cursorPosEnd = textarea.selectionEnd
	const currentValue = textarea.value

	if (
		capslockButton.classList.contains('active') ||
		keyboard.classList.contains('shift-pressed')
	) {
		string = string.toUpperCase()
	}

	textarea.value =
		currentValue.substring(0, cursorPosStart) +
		string +
		currentValue.substring(cursorPosEnd)
	textarea.setSelectionRange(
		cursorPosStart + string.length,
		cursorPosStart + string.length
	)
	textarea.focus()
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Å–∏–º–≤–æ–ª–∞ –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–º –ø–æ–ª–µ
function deleteText(direction) {
	const textarea = document.querySelector('.textarea')
	const startPosition = textarea.selectionStart
	const endPosition = textarea.selectionEnd
	// console.log(startPosition, endPosition)

	if (startPosition === endPosition && startPosition > 0) {
		textarea.value =
			textarea.value.slice(0, startPosition - 1) +
			textarea.value.slice(endPosition)
		textarea.selectionEnd = textarea.selectionStart = startPosition - 1
	} else {
		textarea.value =
			textarea.value.slice(0, startPosition) + textarea.value.slice(endPosition)
		textarea.selectionEnd = textarea.selectionStart = startPosition + direction
	}
	textarea.focus()
}

function toggleCapsLock() {
	const buttons = document.querySelectorAll('button[data-keytype="letter"]')
	buttons.forEach((button) => {
		if (capslockButton.classList.contains('active')) {
			button.classList.add('uppercase')
		} else {
			button.classList.remove('uppercase')
		}
	})
}

function toggleShift() {
	const buttons = document.querySelectorAll('button:not([data-action])')
	buttons.forEach((button) => {
		if (keyboard.classList.contains('shift-pressed')) {
			button.classList.add('uppercase')
		} else {
			button.classList.remove('uppercase')
		}
	})
}

const ctrl = document.querySelector('button[data-code="ControlLeft"]')
ctrl.addEventListener('click', switchLanguage)

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —è–∑—ã–∫–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
function switchLanguage() {
	keyboard.innerHTML = ''
	const newLanguage = currentLanguage === 'en' ? 'ru' : 'en'
	localStorage.setItem('language', newLanguage)
	currentLanguage = newLanguage
	initKeyboard(newLanguage)
}
